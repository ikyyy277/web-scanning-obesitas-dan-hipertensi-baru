<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>VISCERA – Health Risk Screening</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
body { font-family: Arial; background:#f2f4f8; }
.container {
  width:420px; margin:20px auto; background:#fff;
  padding:20px; border-radius:10px;
}
input, button {
  width:100%; padding:8px; margin-top:6px;
}
video {
  width:100%; border-radius:8px; margin-top:10px;
}
.result {
  background:#eef2ff; padding:10px; margin-top:10px;
}
small { color:#666; }
</style>
</head>

<body>
<div class="container">
<h3>VISCERA</h3>
<small>Skrining Risiko Kardiometabolik (Non-Diagnostik)</small>

<h4>Data Fisik</h4>
<input id="umur" placeholder="Umur (tahun)">
<input id="bb" placeholder="Berat Badan (kg)">
<input id="tb" placeholder="Tinggi Badan (cm)">
<input id="denyut" placeholder="Denyut Nadi / menit">

<button onclick="analisisManual()">Analisis Data Fisik</button>

<div id="manualResult" class="result"></div>

<hr>

<h4>Scan Wajah</h4>
<button onclick="mulaiScan()">Mulai Scan Wajah (6 detik)</button>
<video id="video" autoplay muted></video>

<div id="scanStatus"></div>
<div id="finalResult" class="result"></div>
</div>

<script>
/* ================= DATA FISIK ================= */
let manualDone = false;
let manualLevel = "rendah";

function analisisManual(){
  let umur = parseInt(document.getElementById("umur").value);
  let bb = parseFloat(document.getElementById("bb").value);
  let tb = parseFloat(document.getElementById("tb").value) / 100;
  let denyut = parseInt(document.getElementById("denyut").value);

  if (!umur || !bb || !tb || !denyut) {
    alert("Lengkapi semua data fisik");
    return;
  }

  if (tb < 1.3 || tb > 2.1 || bb < 30 || bb > 200) {
    alert("Data fisik tidak masuk akal");
    return;
  }

  let bmi = bb / (tb * tb);
  let score = 0;

  if (bmi >= 25) score++;
  if (denyut > 90) score++;
  if (umur >= 40) score++;

  if (score >= 2) manualLevel = "tinggi";
  else if (score === 1) manualLevel = "sedang";
  else manualLevel = "rendah";

  manualDone = true;

  document.getElementById("manualResult").innerHTML =
    "<b>Hasil Data Fisik</b><br>" +
    "BMI: " + bmi.toFixed(1) + "<br>" +
    "Estimasi risiko dasar: <b>" + manualLevel + "</b><br>" +
    "<small>Silakan lanjutkan ke pemindaian wajah</small>";
}

/* ================= VISUAL ================= */
let video = document.getElementById("video");
let scanStatus = document.getElementById("scanStatus");
let finalResult = document.getElementById("finalResult");

let faceMesh;
let camera;
let scanning = false;
let frame = 0;
let redness = 0;
let tension = 0;

faceMesh = new FaceMesh({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});

faceMesh.onResults(res => {
  if (!scanning) return;
  if (!res.multiFaceLandmarks) return;

  frame++;
  let lm = res.multiFaceLandmarks[0];

  redness += Math.abs(lm[234].x - lm[454].x);
  tension += Math.abs(lm[172].y - lm[397].y);

  if (frame >= 180) {
    scanning = false;
    tampilkanHasil();
  }
});

function mulaiScan(){
  if (!manualDone) {
    alert("Analisis data fisik terlebih dahulu");
    return;
  }

  frame = 0;
  redness = 0;
  tension = 0;
  scanning = true;
  scanStatus.innerHTML = "Scanning wajah ±6 detik...";

  if (!camera) {
    camera = new Camera(video, {
      onFrame: async () => {
        if (scanning) await faceMesh.send({ image: video });
      },
      width: 640,
      height: 480
    });
    camera.start();
  }
}

function tampilkanHasil(){
  let r = redness / frame;
  let t = tension / frame;

  let visualLevel = "rendah";
  if (r > 0.02 || t > 0.015) visualLevel = "sedang";
  if (r > 0.025 && t > 0.02) visualLevel = "tinggi";

  let finalLevel = manualLevel;
  if (visualLevel === "tinggi" || manualLevel === "tinggi")
    finalLevel = "tinggi";
  else if (visualLevel === "sedang")
    finalLevel = "sedang";

  finalResult.innerHTML =
    "<b>Hasil Skrining Terintegrasi</b><br><br>" +
    "• Analisis wajah menunjukkan indikator sirkulasi dan ketegangan otot tingkat <b>" + visualLevel + "</b>.<br>" +
    "• Data fisik menunjukkan risiko dasar <b>" + manualLevel + "</b>.<br><br>" +
    "<b>Kesimpulan:</b><br>" +
    "Estimasi risiko kardiometabolik: <b>" + finalLevel + "</b><br>" +
    "<small>Hasil ini merupakan skrining awal non-diagnostik.</small>";

  scanStatus.innerHTML = "Scan selesai";
}
</script>
</body>
</html>

